version: '3.8'

services:
  # Ganache blockchain service
  ganache:
    image: trufflesuite/ganache:latest
    container_name: dehire-ganache
    ports:
      - "7545:8545"
    command:
      - "--host"
      - "0.0.0.0"
      - "--port"
      - "8545"
      - "--deterministic"
      - "--accounts"
      - "10"
      - "--defaultBalanceEther"
      - "100"
      - "--gasLimit"
      - "6721975"
      - "--gasPrice"
      - "20000000000"
    networks:
      - dehire-network
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/8545' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # Frontend service (Production)
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dehire-frontend
    ports:
      - "3000:80"
    environment:
      - VITE_CONTRACT_ADDRESS=${VITE_CONTRACT_ADDRESS:-}
    depends_on:
      ganache:
        condition: service_healthy
    networks:
      - dehire-network
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf

  # Frontend service (Development)
  frontend-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: dehire-frontend-dev
    ports:
      - "5173:5173"
    environment:
      - VITE_CONTRACT_ADDRESS=${VITE_CONTRACT_ADDRESS:-}
    depends_on:
      ganache:
        condition: service_healthy
    networks:
      - dehire-network
    volumes:
      - .:/app
      - /app/node_modules
    profiles:
      - dev

  # Contract deployment service (optional - runs once)
  contract-deployer:
    image: node:18-alpine
    container_name: dehire-contract-deployer
    working_dir: /app
    volumes:
      - .:/app
    command: >
      sh -c "
        apk add --no-cache netcat-openbsd &&
        echo 'Waiting for Ganache to be ready...' &&
        until nc -z ganache 8545; do
          echo 'Waiting for Ganache...'
          sleep 2
        done &&
        echo 'Ganache is ready. Installing dependencies...' &&
        npm install &&
        echo 'Compiling contracts...' &&
        npm run truffle:compile &&
        echo 'Deploying contracts...' &&
        npm run truffle:migrate &&
        echo 'Contract deployment completed!'
      "
    depends_on:
      ganache:
        condition: service_healthy
    networks:
      - dehire-network
    profiles:
      - deploy

networks:
  dehire-network:
    driver: bridge

